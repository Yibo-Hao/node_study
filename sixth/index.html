<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第四章-Node.js jest 测试 | node学习</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="">
    <link rel="preload" href="/node_study/assets/css/0.styles.d8fcd520.css" as="style"><link rel="preload" href="/node_study/assets/js/app.7ec7703d.js" as="script"><link rel="preload" href="/node_study/assets/js/2.0b30fde4.js" as="script"><link rel="preload" href="/node_study/assets/js/15.240f734b.js" as="script"><link rel="prefetch" href="/node_study/assets/js/10.41c910e2.js"><link rel="prefetch" href="/node_study/assets/js/11.877f2538.js"><link rel="prefetch" href="/node_study/assets/js/12.1dea1fe9.js"><link rel="prefetch" href="/node_study/assets/js/13.03707fd2.js"><link rel="prefetch" href="/node_study/assets/js/14.74174926.js"><link rel="prefetch" href="/node_study/assets/js/16.3d8565bd.js"><link rel="prefetch" href="/node_study/assets/js/17.7817c8e9.js"><link rel="prefetch" href="/node_study/assets/js/3.e87d396a.js"><link rel="prefetch" href="/node_study/assets/js/4.aa1c6637.js"><link rel="prefetch" href="/node_study/assets/js/5.dc83de53.js"><link rel="prefetch" href="/node_study/assets/js/6.42114519.js"><link rel="prefetch" href="/node_study/assets/js/7.5229d775.js"><link rel="prefetch" href="/node_study/assets/js/8.07f7fc74.js"><link rel="prefetch" href="/node_study/assets/js/9.de1235a9.js">
    <link rel="stylesheet" href="/node_study/assets/css/0.styles.d8fcd520.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/node_study/" aria-current="page" class="sidebar-link">Home</a></li><li><a href="/node_study/first/" class="sidebar-link">第一章-Node.js技术架构</a></li><li><a href="/node_study/second/" class="sidebar-link">第二章-Node.js文件模块（基础知识）</a></li><li><a href="/node_study/third/" class="sidebar-link">第二章-Node.js文件模块（Node.js）</a></li><li><a href="/node_study/four/" class="sidebar-link">第三章-package</a></li><li><a href="/node_study/fifth/" class="sidebar-link">第三章-Node.js命令行工具（命令行开发）</a></li><li><a href="/node_study/sixth/" aria-current="page" class="active sidebar-link">第四章-Node.js,jest 测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node_study/sixth/#测试的种类" class="sidebar-link">测试的种类</a></li><li class="sidebar-sub-header"><a href="/node_study/sixth/#jest-基本用法" class="sidebar-link">jest 基本用法</a></li><li class="sidebar-sub-header"><a href="/node_study/sixth/#断言" class="sidebar-link">断言</a></li><li class="sidebar-sub-header"><a href="/node_study/sixth/#异步测试" class="sidebar-link">异步测试</a></li><li class="sidebar-sub-header"><a href="/node_study/sixth/#mock" class="sidebar-link">mock</a></li><li class="sidebar-sub-header"><a href="/node_study/sixth/#mock-node-module" class="sidebar-link">mock Node module</a></li><li class="sidebar-sub-header"><a href="/node_study/sixth/#模块mock例子" class="sidebar-link">模块mock例子</a></li><li class="sidebar-sub-header"><a href="/node_study/sixth/#mock-实现原理" class="sidebar-link">mock 实现原理</a></li><li class="sidebar-sub-header"><a href="/node_study/sixth/#mock-spyon" class="sidebar-link">mock.spyOn</a></li></ul></li><li><a href="/node_study/seventh/" class="sidebar-link">第五章-Node.js,认识V8引擎（基础知识扩展）</a></li><li><a href="/node_study/eighth/" class="sidebar-link">第六章-Node.js,HTTP模块 + path 的两个API</a></li><li><a href="/node_study/ninth/" class="sidebar-link">第七章-Node.js 全局变量</a></li><li><a href="/node_study/tenth/" class="sidebar-link">第八章-Node.js 模块实现 + JS对象小知识点</a></li><li><a href="/node_study/eleventh/" class="sidebar-link">第九章-Node.js DBMS</a></li><li><a href="/node_study/twelve/" class="sidebar-link">第十章-Node.js 流</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第四章-node-js-jest-测试"><a href="#第四章-node-js-jest-测试" class="header-anchor">#</a> 第四章-Node.js jest 测试</h1> <h2 id="测试的种类"><a href="#测试的种类" class="header-anchor">#</a> 测试的种类</h2> <ul><li>单元测试，测试的是函数</li> <li>功能测试，测试的是模块（同时测试很多函数）</li> <li>集成测试，测试能不能承受几百个用户访问，性能测试</li></ul> <h2 id="jest-基本用法"><a href="#jest-基本用法" class="header-anchor">#</a> jest 基本用法</h2> <p>Jest会自动找到项目中所有使用.spec.js或.test.js文件命名的测试文件并执行，通常我们在编写测试文件时遵循的命名规范：测试文件的文件名 = 被测试模块名 + .test.js，例如被测试模块为functions.js，那么对应的测试文件命名为functions.test.js。</p> <p>运行<code>yarn jest</code>即可</p> <h2 id="断言"><a href="#断言" class="header-anchor">#</a> 断言</h2> <p>.not断言-<code>expect(functions.sum(2, 2)).not.toBe(5);</code></p> <p>.not修饰符允许你测试结果不等于某个值的情况</p> <p>.toEqual匹配器会递归的检查对象所有属性和属性值是否相等，所以如果要进行应用类型的比较时，请使用.toEqual匹配器而不是.toBe。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// functions.test.js</span>
<span class="token keyword">import</span> functions  <span class="token keyword">from</span> <span class="token string">'../src/functions'</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'getAuthor()返回的对象深度相等'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>functions<span class="token punctuation">.</span><span class="token function">getAuthor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span>functions<span class="token punctuation">.</span><span class="token function">getAuthor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'getAuthor()返回的对象内存地址不同'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>functions<span class="token punctuation">.</span><span class="token function">getAuthor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>functions<span class="token punctuation">.</span><span class="token function">getAuthor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>.toHaveLength可以很方便的用来测试字符串和数组类型的长度是否满足预期。</p> <p>.toThorw可能够让我们测试被测试方法是否按照预期抛出异常，但是在使用时需要注意的是：我们必须使用一个函数将将被测试的函数做一个包装，很好理解把函数调用包装推迟调用，正如上面getIntArrayWrapFn所做的那样，否则会因为函数抛出导致该断言失败。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// functions.test.js</span>
<span class="token keyword">import</span> functions  <span class="token keyword">from</span> <span class="token string">'../src/functions'</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'getIntArray(3.3)应该抛出错误'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">getIntArrayWrapFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    functions<span class="token punctuation">.</span><span class="token function">getIntArray</span><span class="token punctuation">(</span><span class="token number">3.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>getIntArrayWrapFn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toThrow</span><span class="token punctuation">(</span><span class="token string">'&quot;getIntArray&quot;只接受整数类型的参数'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>.toMatch传入一个正则表达式，它允许我们用来进行字符串类型的正则匹配。</p> <h2 id="异步测试"><a href="#异步测试" class="header-anchor">#</a> 异步测试</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// functions.js</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">fetchUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://jsonplaceholder.typicode.com/users/1'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// functions.test.js</span>
<span class="token keyword">import</span> functions  <span class="token keyword">from</span> <span class="token string">'../src/functions'</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'fetchUser() 可以请求到一个含有name属性值为Leanne Graham的对象'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  expect<span class="token punctuation">.</span><span class="token function">assertions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> functions<span class="token punctuation">.</span><span class="token function">fetchUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'Leanne Graham'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上面我们调用了expect.assertions(1)，它能确保在异步的测试用例中，有一个断言会在回调函数中被执行。这在进行异步代码的测试中十分有效。</p> <p>使用async和await精简异步代码</p> <div class="language- extra-class"><pre class="language-text"><code>test('fetchUser() 可以请求到一个用户名字为Leanne Graham', async () =&gt; {
  expect.assertions(1);
  const data =  await functions.fetchUser();
  expect(data.name).toBe('Leanne Graham')
})
</code></pre></div><h2 id="mock"><a href="#mock" class="header-anchor">#</a> mock</h2> <p>一个模块的方法内常常会去调用另外一个模块的方法。在单元测试中，我们可能并不需要关心内部调用的方法的执行过程和结果，只想知道它是否被正确调用即可，甚至会指定该函数的返回值。此时，使用Mock函数是十分有必要。单元测试时为了屏蔽函数对外部的依赖。</p> <p>jest 里有两种 mock，一种是方法的 mock，还有一种是模块的 mock。</p> <p>Mock函数提供的以下三种特性，在我们写测试代码时十分有用：</p> <ul><li>捕获函数调用情况</li> <li>设置函数返回值</li> <li>改变函数的内部实现</li></ul> <h3 id="jest-fn"><a href="#jest-fn" class="header-anchor">#</a> jest.fn()</h3> <p>jest.fn()是创建Mock函数最简单的方式，如果没有定义函数内部的实现，jest.fn()会返回undefined作为返回值。它的用途很简单来断言一个回调是否被调用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> fetch <span class="token keyword">from</span> <span class="token string">'../src/fetch.js'</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'fetchPostsList中的回调函数应该能够被调用'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  expect<span class="token punctuation">.</span><span class="token function">assertions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> mockFn <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> fetch<span class="token punctuation">.</span><span class="token function">fetchPostsList</span><span class="token punctuation">(</span>mockFn<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 断言mockFn被调用</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mockFn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="jest-mock"><a href="#jest-mock" class="header-anchor">#</a> jest.mock()</h3> <p>使用jest.mock(）去mock整个模块，如果jest.fn()指的是假函数，那么jest.mock()指的就是假的模块。</p> <p>一个更为常见的方法是使用 jest.mock 自动为一个模块中所有的 exports 设定 mock function。</p> <p>我们可以为所有当前模块 exports 出的对象使用上述 Mock Function 的所有特性</p> <h2 id="mock-node-module"><a href="#mock-node-module" class="header-anchor">#</a> mock Node module</h2> <p>如果你要 mock node 模块，被模拟的模块一个放在根目录里的__mocks__文件中），拿下面例子为例解释为什么要mock fs 模块，我们要测试db.read函数，但是db里面涉及到fs.readFile函数，我们实际上需要读到某个文件，然后提取信息才可以，我们可以在测试里加一行代码来生成一个文件，但是如果文件已经存在导致出错，从而测试用例失败，这样就检测不出来错误了，所以我们 mock 掉 fs 模块，让fs.readFile函数不再读取文件，而是返回我们设定的值，这样我们就不在专注于创建文件让函数去读而专注于其他逻辑。</p> <h2 id="模块mock例子"><a href="#模块mock例子" class="header-anchor">#</a> 模块mock例子</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//db.spec.js </span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'db'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">clearMocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'can read'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>title<span class="token operator">:</span> <span class="token string">'hi'</span><span class="token punctuation">,</span> done<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
    fs<span class="token punctuation">.</span><span class="token function">setReadFileMock</span><span class="token punctuation">(</span><span class="token string">'/xxx'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token string">'/xxx'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'can write'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> fakeFile
    fs<span class="token punctuation">.</span><span class="token function">setWriteFileMock</span><span class="token punctuation">(</span><span class="token string">'/yyy'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> data<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      fakeFile <span class="token operator">=</span> data
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>title<span class="token operator">:</span> <span class="token string">'见欧阳娜娜'</span><span class="token punctuation">,</span> done<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>title<span class="token operator">:</span> <span class="token string">'见迪丽热巴'</span><span class="token punctuation">,</span> done<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token string">'/yyy'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>fakeFile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">///__mocks__/fs.js</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">genMockFromModule</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> _fs <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">requireActual</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>fs<span class="token punctuation">,</span> _fs<span class="token punctuation">)</span>

<span class="token keyword">let</span> readMocks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

fs<span class="token punctuation">.</span><span class="token function-variable function">setReadFileMock</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> error<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  readMocks<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>error<span class="token punctuation">,</span> data<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

fs<span class="token punctuation">.</span><span class="token function-variable function">readFile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>callback <span class="token operator">=</span> options<span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token keyword">in</span> readMocks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token operator">...</span>readMocks<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    _fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> writeMocks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

fs<span class="token punctuation">.</span><span class="token function-variable function">setWriteFileMock</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  writeMocks<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> fn
<span class="token punctuation">}</span>

fs<span class="token punctuation">.</span><span class="token function-variable function">writeFile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> data<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token keyword">in</span> writeMocks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    writeMocks<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> data<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    _fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> data<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

fs<span class="token punctuation">.</span><span class="token function-variable function">clearMocks</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  readMocks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  writeMocks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>


module<span class="token punctuation">.</span>exports <span class="token operator">=</span> fs
</code></pre></div><ul><li>.genMockFromModule()会覆盖模块的默认行为，这样我们就可以写出我们自己的fs.readFile，</li> <li>而requireActual是为了当我们写的fs.readFile出错是调用的。</li> <li>setReadFileMock是为了省去创建文件这一过程，使readFile使用readMocks的数据</li></ul> <h2 id="mock-实现原理"><a href="#mock-实现原理" class="header-anchor">#</a> mock 实现原理</h2> <p>这一步跟 node 的模块实现类似：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> __dirname<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> global<span class="token punctuation">,</span> jest</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span><span class="token string">'/tmp/file'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="mock-spyon"><a href="#mock-spyon" class="header-anchor">#</a> mock.spyOn</h2> <p>jest.spyOn()方法同样创建一个mock函数，但是该mock函数不仅能够捕获函数的调用情况，还可以正常的执行被spy的函数。实际上，jest.spyOn()是jest.fn()的语法糖，它创建了一个和被spy的函数具有相同内部代码的mock函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// functions.test.js</span>

<span class="token keyword">import</span> events <span class="token keyword">from</span> <span class="token string">'../src/events'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> fetch <span class="token keyword">from</span> <span class="token string">'../src/fetch'</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'使用jest.spyOn()监控fetch.fetchPostsList被正常调用'</span><span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  expect<span class="token punctuation">.</span><span class="token function">assertions</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> spyFn <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>fetch<span class="token punctuation">,</span> <span class="token string">'fetchPostsList'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> events<span class="token punctuation">.</span><span class="token function">getPostList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>spyFn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>spyFn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <blockquote><p>https://medium.com/@KumaLi1983/%E7%90%86%E8%A7%A3-jest-mocks-ec7adfeab2d1</p></blockquote></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/node_study/fifth/" class="prev">
        第三章-Node.js命令行工具（命令行开发）
      </a></span> <span class="next"><a href="/node_study/seventh/">
        第五章-Node.js,认识V8引擎（基础知识扩展）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/node_study/assets/js/app.7ec7703d.js" defer></script><script src="/node_study/assets/js/2.0b30fde4.js" defer></script><script src="/node_study/assets/js/15.240f734b.js" defer></script>
  </body>
</html>
