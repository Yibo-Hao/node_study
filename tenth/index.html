<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第八章-Node.js 模块实现 + JS对象小知识点 | node学习</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="">
    <link rel="preload" href="/node_study/assets/css/0.styles.d8fcd520.css" as="style"><link rel="preload" href="/node_study/assets/js/app.7ec7703d.js" as="script"><link rel="preload" href="/node_study/assets/js/2.0b30fde4.js" as="script"><link rel="preload" href="/node_study/assets/js/16.3d8565bd.js" as="script"><link rel="prefetch" href="/node_study/assets/js/10.41c910e2.js"><link rel="prefetch" href="/node_study/assets/js/11.877f2538.js"><link rel="prefetch" href="/node_study/assets/js/12.1dea1fe9.js"><link rel="prefetch" href="/node_study/assets/js/13.03707fd2.js"><link rel="prefetch" href="/node_study/assets/js/14.74174926.js"><link rel="prefetch" href="/node_study/assets/js/15.240f734b.js"><link rel="prefetch" href="/node_study/assets/js/17.7817c8e9.js"><link rel="prefetch" href="/node_study/assets/js/3.e87d396a.js"><link rel="prefetch" href="/node_study/assets/js/4.aa1c6637.js"><link rel="prefetch" href="/node_study/assets/js/5.dc83de53.js"><link rel="prefetch" href="/node_study/assets/js/6.42114519.js"><link rel="prefetch" href="/node_study/assets/js/7.5229d775.js"><link rel="prefetch" href="/node_study/assets/js/8.07f7fc74.js"><link rel="prefetch" href="/node_study/assets/js/9.de1235a9.js">
    <link rel="stylesheet" href="/node_study/assets/css/0.styles.d8fcd520.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/node_study/" aria-current="page" class="sidebar-link">Home</a></li><li><a href="/node_study/first/" class="sidebar-link">第一章-Node.js技术架构</a></li><li><a href="/node_study/second/" class="sidebar-link">第二章-Node.js文件模块（基础知识）</a></li><li><a href="/node_study/third/" class="sidebar-link">第二章-Node.js文件模块（Node.js）</a></li><li><a href="/node_study/four/" class="sidebar-link">第三章-package</a></li><li><a href="/node_study/fifth/" class="sidebar-link">第三章-Node.js命令行工具（命令行开发）</a></li><li><a href="/node_study/sixth/" class="sidebar-link">第四章-Node.js,jest 测试</a></li><li><a href="/node_study/seventh/" class="sidebar-link">第五章-Node.js,认识V8引擎（基础知识扩展）</a></li><li><a href="/node_study/eighth/" class="sidebar-link">第六章-Node.js,HTTP模块 + path 的两个API</a></li><li><a href="/node_study/ninth/" class="sidebar-link">第七章-Node.js 全局变量</a></li><li><a href="/node_study/tenth/" aria-current="page" class="active sidebar-link">第八章-Node.js 模块实现 + JS对象小知识点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node_study/tenth/#module-的本质" class="sidebar-link">Module 的本质</a></li><li class="sidebar-sub-header"><a href="/node_study/tenth/#模块分类" class="sidebar-link">模块分类</a></li><li class="sidebar-sub-header"><a href="/node_study/tenth/#module-实现思路" class="sidebar-link">module 实现思路</a></li><li class="sidebar-sub-header"><a href="/node_study/tenth/#es6-模块与-commonjs-模块的差异（普通值的赋值问题）" class="sidebar-link">ES6 模块与 CommonJS 模块的差异（普通值的赋值问题）</a></li><li class="sidebar-sub-header"><a href="/node_study/tenth/#js对象" class="sidebar-link">JS对象</a></li><li class="sidebar-sub-header"><a href="/node_study/tenth/#commonjs-的循环加载" class="sidebar-link">commonjs 的循环加载</a></li></ul></li><li><a href="/node_study/eleventh/" class="sidebar-link">第九章-Node.js DBMS</a></li><li><a href="/node_study/twelve/" class="sidebar-link">第十章-Node.js 流</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第八章-node-js-模块实现-js对象小知识点"><a href="#第八章-node-js-模块实现-js对象小知识点" class="header-anchor">#</a> 第八章-Node.js 模块实现 + JS对象小知识点</h1> <h2 id="module-的本质"><a href="#module-的本质" class="header-anchor">#</a> Module 的本质</h2> <p>JavaScript 有一个很大的缺陷就是缺少 namespacing 的概念，程序运行在全局作用域下，很容易被内部应用程序的代码或者是第三方依赖程序的数据所污染，一个很典型的解决方案就使通过 IIFE 来解决，本质上是利用闭包来解决。</p> <h2 id="模块分类"><a href="#模块分类" class="header-anchor">#</a> 模块分类</h2> <p>在Node中引入模块，需要经历如下3个步骤。路径分析，文件定位，编译执行。</p> <p>按照模块的分类，按照以下顺序进行优先加载：</p> <p>系统缓存：模块被执行之后会会进行缓存，首先是先进行缓存加载，判断缓存中是否有值。</p> <p>系统模块：也就是原生模块，这个优先级仅次于缓存加载，部分核心模块已经被编译成二进制，省略了路径分析、文件定位，直接加载到了内存中，系统模块定义在Node.js源码的lib目录下，可以去查看。</p> <p>文件模块：优先加载.、..、/开头的，如果文件没有加上扩展名，会依次按照.js、.json、.node进行扩展名补足尝试，那么在尝试的过程中也是以同步阻塞模式来判断文件是否存在，从性能优化的角度来看待，.json、.node最好还是加上文件的扩展名。</p> <p>目录做为模块：这种情况发生在文件模块加载过程中，也没有找到，但是发现是一个目录的情况，这个时候会将这个目录当作一个包来处理，Node这块采用了Commonjs规范，先会在项目根目录查找package.json文件，取出文件中定义的main属性(&quot;main&quot;: &quot;lib/hello.js&quot;)描述的入口文件进行加载，也没加载到，则会抛出默认错误: Error: Cannot find module 'lib/hello.js'</p> <h2 id="module-实现思路"><a href="#module-实现思路" class="header-anchor">#</a> module 实现思路</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//引入Node的核心模块</span>
<span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Module</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> p<span class="token punctuation">;</span> <span class="token comment">//当前模块的标识，也就是绝对路径</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//每个模块都有exports属性，添加一个</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//是否已经加载完</span>
<span class="token punctuation">}</span>
<span class="token comment">//对文件内容进行头尾包装</span>
Module<span class="token punctuation">.</span>wrapper <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'(function(exports,require,module){'</span><span class="token punctuation">,</span> <span class="token string">'})'</span><span class="token punctuation">]</span>

<span class="token comment">//所有的加载策略</span>
Module<span class="token punctuation">.</span>_extensions <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'.js'</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//读取js文件，增加一个闭包</span>
        <span class="token keyword">let</span> script <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> fn <span class="token operator">=</span> Module<span class="token punctuation">.</span>wrapper<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> script <span class="token operator">+</span> Module<span class="token punctuation">.</span>wrapper<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//包装在一个闭包里</span>
        vm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> myRequire<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过runInThisContext()方法执行不污染全局</span>
        <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'.json'</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//读取文件</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Module<span class="token punctuation">.</span>_cacheModule <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">//存放缓存</span>

Module<span class="token punctuation">.</span><span class="token function-variable function">_resolveFileName</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//根据传入的路径参数返回一个绝对路径的方法</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果没有传文件后缀</span>
        <span class="token keyword">let</span> arr <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将对象的key转成数组</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//循坏数组添加后缀</span>
            <span class="token keyword">let</span> file <span class="token operator">=</span> p <span class="token operator">+</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                fs<span class="token punctuation">.</span><span class="token function">accessSync</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//查看文件是否存在，存在的就返回</span>
                <span class="token keyword">return</span> file<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//不存在报错</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> p<span class="token punctuation">;</span> <span class="token comment">//如果已经传递了文件后缀，直接返回绝对路径</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">load</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">filepath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//模块加载的方法</span>
    <span class="token keyword">let</span> ext <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> content <span class="token operator">=</span> Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span>ext<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> content<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">myRequire</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//自定义的myRequire方法</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_resolveFileName</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将传递进来的模块标示转成绝对路径</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Module<span class="token punctuation">.</span>_cacheModule<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果模块已经存在</span>
        <span class="token keyword">return</span> Module<span class="token punctuation">.</span>_cacheModule<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span> <span class="token comment">//直接返回编译和执行之后的对象</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//模块不存在，先创建一个新的模块对象</span>
    <span class="token keyword">let</span> content <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//模块加载后的内容</span>
    Module<span class="token punctuation">.</span>_cacheModule<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> module<span class="token punctuation">;</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> content<span class="token punctuation">;</span>
    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">myRequire</span><span class="token punctuation">(</span><span class="token string">'./a.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>module 变量包含的只有对外暴露的 API，然而剩下的 module 内容是对外不可见的，而这个也是 Node module system 最核心的思想。</p> <p>下面我们从 myRequire 分析代码，只分析 js 模块：</p> <ol><li>根据 myRequire 参数找到模块的绝对路径 p 。</li> <li>以 p 为 key 查看缓存，如果没有缓存那么创建新的 Module 类。</li> <li>接下来开始加载模块</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> script <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fn <span class="token operator">=</span> Module<span class="token punctuation">.</span>wrapper<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> script <span class="token operator">+</span> Module<span class="token punctuation">.</span>wrapper<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//包装在一个闭包里</span>
</code></pre></div><p>○ 1. 根据绝对路径来读取文件<br>
○ 2. 使用<code>['(function(exports,require,module){', '})']</code>来包裹住读取到的文件
4. 假设<code>'console.log(module)'</code>是模块内部代码，经过第三步转化后变为以下代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="5"><li>上面实际执行的函数通过<strong>利用闭包</strong>修改参数<code>module.exports</code>，来达到导出的目的</li></ol> <h2 id="es6-模块与-commonjs-模块的差异（普通值的赋值问题）"><a href="#es6-模块与-commonjs-模块的差异（普通值的赋值问题）" class="header-anchor">#</a> ES6 模块与 CommonJS 模块的差异（普通值的赋值问题）</h2> <p>讨论 Node.js 加载 ES6 模块之前，必须了解 ES6 模块与 CommonJS 模块完全不同。</p> <p>它们有两个重大差异。</p> <p>CommonJS 模块输出的是一个值的拷贝，ES6 模块输出的是值的引用。</p> <p>CommonJS 模块是运行时加载，ES6 模块是编译时输出接口。</p> <p>第二个差异是因为 CommonJS 加载的是一个对象（即module.exports属性），该对象只有在脚本运行完才会生成。而 ES6 模块不是对象，它的对外接口只是一种静态定义，在代码静态解析阶段就会生成。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> a
<span class="token keyword">const</span> <span class="token function-variable function">add</span>  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    a  <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2</span>
</code></pre></div><p>普通值赋值时会直接赋值，commonjs 和上面代码类似，是在module.exports对象中赋值</p> <p>ES6 模块的运行机制与 CommonJS 不一样。JS 引擎对脚本静态分析的时候，遇到模块加载命令import，就会生成一个只读引用。等到脚本真正执行时，再根据这个只读引用，到被加载的那个模块里面去取值。换句话说，ES6 的import有点像 Unix 系统的“符号连接”，原始值变了，import加载的值也会跟着变。因此，ES6 模块是动态引用，并且不会缓存值，模块里面的变量绑定其所在的模块。</p> <h2 id="js对象"><a href="#js对象" class="header-anchor">#</a> JS对象</h2> <p>javascript不允许直接访问内存中的位置，不能直接操作对象的内存空间。实际上操作的是对象的引用，所以引用类型的值是按引用访问的。准确说引用类型的存储需要内存的栈区和堆区(堆内存)共同完成，栈区内保存变量标识符和指向堆内存中该对象的指针(也可以说该对象在堆内存中的地址)。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> exports <span class="token operator">=</span> modules<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>

<span class="token comment">//错误的写法 将会得到undefined</span>
exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">'a'</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token string">'b'</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token comment">//正确的写法</span>
modules<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">'a'</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token string">'b'</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是要注意不能改变exports的指向，我们可以通过 exports.test = 'a' 这样来导出一个对象, 但是不能向上面示例直接赋值，这样会改变exports的指向。</p> <p>因为<code>const exports = modules.exports;</code>意思是modules.exports的地址赋给了exports，接下来对exports进行对象地址赋值，表示exports指向了完全不同的两块内存。</p> <h2 id="commonjs-的循环加载"><a href="#commonjs-的循环加载" class="header-anchor">#</a> commonjs 的循环加载</h2> <p>CommonJS 输入的是被输出值的拷贝，不是引用。</p> <p>CommonJS 模块遇到循环加载时，返回的是当前已经执行的部分的值，而不是代码全部执行后的值，两者可能会有差异。所以，输入变量的时候，必须非常小心。</p> <blockquote><p>https://juejin.im/post/5b0266216fb9a07ac23b099a#heading-1</p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/node_study/ninth/" class="prev">
        第七章-Node.js 全局变量
      </a></span> <span class="next"><a href="/node_study/eleventh/">
        第九章-Node.js DBMS
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/node_study/assets/js/app.7ec7703d.js" defer></script><script src="/node_study/assets/js/2.0b30fde4.js" defer></script><script src="/node_study/assets/js/16.3d8565bd.js" defer></script>
  </body>
</html>
